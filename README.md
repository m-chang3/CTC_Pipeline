# OHSU-CTC_pipeline
Pipeline to run CTC libraries generated by SMARTseq2 against the hg38 genome verison. Adapted from the original pipeline created by Aaron Doe at the location https://github.com/ohsu-cedar-comp-hub/scRNA_SMARTseq2

# Steps to run the pipeline:
1) Copy the folder hg38_pipeline_fresh/fresh_snakemake_files into a new working directory (above hg38_pipeline_fresh)

2) Symlink samples into the folder samples/raw/ within the fresh_snakemake_files directory. You can use the command "ln -s /path/to/samples/* ./samples/raw" (from the fresh_snakemake_files directory)

3) Ensure that the samples are in the proper naming format. Samples must be named with the suffix "_R1.fq.gz"

4) Update the omic_config.yaml file with the Seurat parameters required.

5) Create a conda environment with the package snakemake installed. You can install by creating a new environment, activating it, and running the command "conda install -c bioconda snakemake=4.3.0". You MUST use Snakemake version 4.3.0!

6) Use gunzip to unzip the .bed and .gtf files in pipeline_files

7) Download the Hisat2 tool (version 2.0.4) and create a Hisat index for hg38. Update the omic_config.yaml file accordingly.

8) Do a dry run of Snakemake to ensure everything is functioning properly. Use the command "snakemake -np --verbose" from the directory containing the Snakefile.

9) You're ready to run! Use the command "sbatch submit_snakemake.sh" on a slurm job scheduler to get the run started.

# Pipeline Input and Output:

### Input:

This pipeline takes as input zipped FASTQ files from SMARTseq2 sequencing

### Output:

This pipeline outputs several intermediate files. Trimmed samples are saved, as well as FASTQC output on each sample. Additionally, BAM files are generated by Hisat2 for each sample. A raw counts file is generated alongside a filtered raw counts file. Sample metadata and gene metadata are additionally created. 

At the end, this pipeline outputs several Seurat plots as well as a Seurat .RDS object which can be loaded separately into Seurat for additional analysis. The Seurat plots are as follows: Violin and scatter plots describing QC metrics, a heatmap of the top 20 genes differentially expressed, an elbow plot for PC analysis, a UMAP plot displaying the data, and a stacked Violin plot showing the top 10 genes differentially expressed by cluster.

# Pipeline Components:

### Trimming

This pipeline uses TrimGalore to trim samples and run FASTQC on the samples

### Fastqscreen

This package produces more QC reports per sample

### Mapping

Hisat2 is used to map the reads to the hg38 (GRCh 38) genome

### Feature Count

featureCounts is used to count reads mapped to individual features (genes)

### Filter Counts

A custom R script (developed by Aaron Doe) is used to filter the counts TSV file by parameters set in the omics_config.yaml file. Options include filtering by mitochondrial contamination and biotype.

### Seurat

This script (originally created by Aaron Doe, updated by Matt Chang) creates a Seurat Object (.RDS file) and outputs plots described above.

